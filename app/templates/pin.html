{#
  This template renders all Person-In-Need (PIN) pages: create, dashboard (list), edit and history.
  The layout is self‑contained and replicates the visual style of the user admin pages provided in
  the design mockups.  We include a top bar, a vertical side navigation for the PIN module,
  and a content area that switches based on the `view` variable supplied by the routes.

  The page uses minimal inline CSS to achieve a consistent look without depending on external
  stylesheets.  Colours and spacing are derived from the screenshots: a dark blue primary bar,
  a light blue background for the main content, an orange accent colour for buttons and highlights,
  and clean tables.

  Variables expected in context:
    - view: str in {"create", "dashboard", "edit", "history"}
    - categories: list of Category objects (for select options)
    - reqs: list of Request objects when view == "dashboard"
    - req: a Request object when view == "edit"
    - history_preview: list of recent ServiceHistory when view == "dashboard" (optional)
    - items: list of ServiceHistory objects when view == "history"
    - page, per_page, pages, q: pagination/search parameters for dashboard
    - category_id, start, end: filter parameters for history
    - next: url to return to after edit form, if supplied
    - username: optional display name; if absent, a placeholder is used

  Note: the logout button simply links to the boundary.logout route and does not require
  a separate form for CSRF protection because it performs a GET request.  If your security
  requirements mandate POST for logout, wrap it in a form accordingly.
#}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PIN Management</title>
  <style>
    :root {
      --primary: #0a4ea3;        /* dark blue from the mockups */
      --primary-dark: #083c7a;
      --secondary: #d9efff;      /* light blue for page background */
      --accent: #f5a623;         /* orange for buttons and active menu */
      --danger: #e74c3c;         /* red for logout */
      --white: #ffffff;
      --grey-light: #f6f9fc;
      --grey-border: #e1e7ef;
    }

    /* Reset basic tags */
    * { box-sizing: border-box; }
    body { margin: 0; font-family: sans-serif; background: var(--secondary); }
    a { text-decoration: none; color: inherit; }
    button { cursor: pointer; }

    /* Top navigation bar */
    .pin-topbar {
      background: var(--primary);
      color: var(--white);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .pin-topbar .title {
      font-size: 1.4rem;
      font-weight: 700;
      letter-spacing: 0.5px;
    }
    .pin-topbar .user-section {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 1rem;
    }
    .pin-topbar .logout-btn {
      background: var(--danger);
      color: var(--white);
      border: none;
      border-radius: 4px;
      padding: 6px 16px;
      font-size: 0.9rem;
    }

    /* Layout: sidebar + content */
    .pin-layout {
      display: flex;
      min-height: calc(100vh - 56px); /* subtract topbar height */
    }
    .pin-sidebar {
      width: 260px;
      background: var(--primary);
      color: var(--white);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
    }
    .pin-sidebar h3 {
      margin: 0 0 16px;
      font-size: 1.2rem;
      font-weight: 700;
    }
    .pin-sidebar nav a {
      display: block;
      padding: 10px 12px;
      margin-bottom: 4px;
      font-size: 1.05rem;
      color: var(--white);
      border-left: 4px solid transparent;
      transition: background 0.2s, color 0.2s;
    }
    .pin-sidebar nav a:hover {
      background: var(--primary-dark);
    }
    .pin-sidebar nav a.active {
      color: var(--accent);
      border-left-color: var(--accent);
      font-weight: 600;
    }

    /* Main content area */
    .pin-content {
      flex: 1;
      padding: 32px;
      background: var(--secondary);
    }
    .pin-content h1 {
      margin-top: 0;
      margin-bottom: 20px;
      font-size: 2rem;
      color: var(--primary);
      text-align: center;
      font-weight: 700;
    }

    /* Forms */
    .form-group {
      margin-bottom: 16px;
    }
    .form-group label {
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid var(--grey-border);
      border-radius: 6px;
      font-size: 1rem;
      background: var(--white);
    }
    .form-row {
      display: flex;
      gap: 12px;
    }
    .form-row .form-group {
      flex: 1;
    }
    .btn-submit {
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-size: 1rem;
    }
    .btn-cancel {
      background: var(--grey-border);
      color: var(--primary);
      border: none;
      border-radius: 6px;
      padding: 10px 24px;
      font-size: 1rem;
    }

    /* Search bar */
    .search-bar {
      display: flex;
      margin-bottom: 20px;
      gap: 12px;
    }
    .search-bar input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid var(--grey-border);
      border-radius: 6px;
      font-size: 1rem;
      background: var(--white);
    }
    .search-bar button {
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      font-size: 1rem;
    }

    /* Tables */
    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 8px;
      overflow: hidden;
    }
    thead {
      background: var(--primary);
      color: var(--white);
    }
    th, td {
      padding: 12px 16px;
      text-align: left;
      font-size: 0.95rem;
      border-bottom: 1px solid var(--grey-border);
    }
    tbody tr:nth-child(even) {
      background: var(--grey-light);
    }
    .actions-btn {
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      font-size: 0.85rem;
    }

    /* Pagination */
    .pagination {
      margin-top: 16px;
      text-align: center;
    }
    .pagination a, .pagination span {
      display: inline-block;
      padding: 6px 12px;
      margin: 0 2px;
      border: 1px solid var(--primary);
      border-radius: 4px;
      color: var(--primary);
      font-size: 0.9rem;
    }
    .pagination a:hover {
      background: var(--primary);
      color: var(--white);
    }
    .pagination .active {
      background: var(--primary);
      color: var(--white);
      pointer-events: none;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .pin-layout { flex-direction: column; }
      .pin-sidebar { width: 100%; height: auto; }
      .pin-content { padding: 20px; }
      th, td { white-space: normal; }
    }
  </style>
</head>
<body>
  <!-- Top bar -->
  <div class="pin-topbar">
    <div class="title">VOLUNTEER MANAGEMENT SYSTEM</div>
    <div class="user-section">
      <div class="user-name">{{ session.get('username', 'Username') }}</div>
      <div class="user-role">PIN</div>
      <a href="{{ url_for('boundary.logout') }}" class="logout-btn">LOGOUT</a>
    </div>
  </div>

  <!-- Sidebar + Content -->
  <div class="pin-layout">
    <!-- Sidebar -->
    <aside class="pin-sidebar">
      <h3>PIN Management</h3>
      <nav>
        <a href="{{ url_for('boundary.pin_new_req') }}" class="{% if view == 'create' %}active{% endif %}">Create new Request</a>
        <a href="{{ url_for('boundary.pin_dashboard') }}" class="{% if view == 'dashboard' %}active{% endif %}">My Requests</a>
        <a href="{{ url_for('boundary.pin_history') }}" class="{% if view == 'history' %}active{% endif %}">completed Requests</a>
      </nav>
    </aside>

    <!-- Main content -->
    <main class="pin-content">
      {# CREATE NEW REQUEST #}
      {% if view == 'create' %}
        <h1>Create New Request</h1>
        <form method="post" action="{{ url_for('boundary.pin_create_req') }}">
          <div class="form-group">
            <label for="cat">Category</label>
            <select id="cat" name="category_id">
              <option value="" disabled selected>Select category</option>
              {% for c in categories %}
                <option value="{{ c.id }}">{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="title">Title</label>
            <input id="title" name="title" type="text" placeholder="Enter title" required />
          </div>
          <div class="form-group">
            <label for="description">Request</label>
            <textarea id="description" name="description" rows="5" placeholder="Enter your request in detail"></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn-submit">Create Request</button>
          </div>
        </form>

      {# DASHBOARD (My Requests) #}
      {% elif view == 'dashboard' %}
        <h1>My Requests</h1>
        <form method="get" class="search-bar" action="{{ url_for('boundary.pin_dashboard') }}">
          <input type="text" name="q" value="{{ q }}" placeholder="Search my requests" />
          <button type="submit">Search</button>
        </form>
        {% if reqs and reqs|length > 0 %}
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Category</th>
                  <th>Status</th>
                  <th>Accepted By</th>
                  <th>Views</th>
                  <th>Shortlisted</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for r in reqs %}
                <tr>
                  <td>{{ r.id }}</td>
                  <td>{{ r.title }}</td>
                  <td>{{ r.category.name if r.category else '-' }}</td>
                  <td>{{ r.status }}</td>
                  <td>
                    {% if r.accepted_csr and (r.accepted_csr.first_name or r.accepted_csr.last_name) %}
                      {{ r.accepted_csr.first_name }} {{ r.accepted_csr.last_name }}
                    {% elif r.accepted_csr %}
                      {{ r.accepted_csr.username }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>{{ r.views_count or 0 }}</td>
                  <td>{{ r.shortlist_count or 0 }}</td>
                  <td>
                    <a href="{{ url_for('boundary.pin_edit_req', req_id=r.id, page=page, per_page=per_page, q=q) }}" class="actions-btn">Edit</a>
                    <form method="post" action="{{ url_for('boundary.pin_delete_req', req_id=r.id) }}" style="display:inline;" onsubmit="return confirm('Delete this request?');">
                      <input type="hidden" name="next" value="{{ url_for('boundary.pin_dashboard', page=page, per_page=per_page, q=q) }}" />
                      <button type="submit" class="actions-btn" style="margin-left:4px; background: var(--danger);">Delete</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {# Pagination #}
          <div class="pagination">
            {% set cur = page or 1 %}
            {% set last = pages or 1 %}
            {% if cur > 1 %}
              <a href="{{ url_for('boundary.pin_dashboard', page=cur-1, per_page=per_page, q=q) }}">Previous</a>
            {% else %}
              <span class="disabled">Previous</span>
            {% endif %}
            {% for p in range(1, last+1) %}
              {% if p == cur %}
                <span class="active">{{ p }}</span>
              {% else %}
                <a href="{{ url_for('boundary.pin_dashboard', page=p, per_page=per_page, q=q) }}">{{ p }}</a>
              {% endif %}
            {% endfor %}
            {% if cur < last %}
              <a href="{{ url_for('boundary.pin_dashboard', page=cur+1, per_page=per_page, q=q) }}">Next</a>
            {% else %}
              <span class="disabled">Next</span>
            {% endif %}
          </div>
        {% else %}
          <p>No requests found. Create your first request using the menu.</p>
        {% endif %}

      {# EDIT REQUEST #}
      {% elif view == 'edit' %}
        <h1>Update Request</h1>
        {% if req.accepted_csr %}
          <div style="margin-bottom:12px; padding:10px; border:1px solid #e1e7ef; border-radius:6px; background:#fff;">
            <strong>Accepted by:</strong>
            {% if req.accepted_csr.first_name or req.accepted_csr.last_name %}
              {{ req.accepted_csr.first_name }} {{ req.accepted_csr.last_name }}
            {% else %}
              {{ req.accepted_csr.username }}
            {% endif %}
            {% if req.accepted_at %}
              <span style="color:#666; font-size:0.9rem;"> — {{ req.accepted_at.date() }}</span>
            {% endif %}
          </div>
        {% else %}
          <div style="margin-bottom:12px; color:#666;">No volunteer has accepted this request yet.</div>
        {% endif %}
        <form method="post" action="{{ url_for('boundary.pin_update_req', req_id=req.id) }}">
          <input type="hidden" name="next" value="{{ next or url_for('boundary.pin_dashboard', page=page, per_page=per_page, q=q) }}" />
          <input type="hidden" name="page" value="{{ page }}" />
          <input type="hidden" name="per_page" value="{{ per_page }}" />
          <input type="hidden" name="q" value="{{ q }}" />
          <div class="form-group">
            <label for="cat">Category</label>
            <select id="cat" name="category_id">
              {% for c in categories %}
                <option value="{{ c.id }}" {% if c.id == req.category_id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group">
            <label for="title">Title</label>
            <input id="title" name="title" type="text" value="{{ req.title }}" required />
          </div>
          <div class="form-group">
            <label for="description">Request</label>
            <textarea id="description" name="description" rows="5">{{ req.description }}</textarea>
          </div>
          <div class="form-group">
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="open" {% if req.status == 'open' %}selected{% endif %}>Open</option>
              <option value="completed" {% if req.status == 'completed' %}selected{% endif %}>Completed</option>
            </select>
          </div>
          <div class="form-group" style="display:flex; gap:12px; font-size:0.9rem; color: var(--primary);">
            <div>Views: <strong>{{ req.views_count or 0 }}</strong></div>
            <div>Shortlisted: <strong>{{ req.shortlist_count or 0 }}</strong></div>
          </div>
          <div class="form-row" style="margin-top:16px;">
            <button type="submit" class="btn-submit">Save</button>
            <a href="{{ next or url_for('boundary.pin_dashboard', page=page, per_page=per_page, q=q) }}" class="btn-cancel" style="padding: 10px 24px;">Cancel</a>
          </div>
        </form>

      {# HISTORY (Completed Requests) #}
      {% elif view == 'history' %}
        <h1>Completed Requests</h1>
        <form method="get" class="search-bar" action="{{ url_for('boundary.pin_history') }}" style="flex-wrap: wrap; gap: 12px;">
          <div style="flex: 1; min-width: 160px;">
            <select name="category_id" style="width: 100%; padding: 10px; border: 1px solid var(--grey-border); border-radius: 6px;">
              <option value="">All categories</option>
              {% for c in categories %}
                <option value="{{ c.id }}" {% if category_id and c.id == category_id %}selected{% endif %}>{{ c.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div style="flex: 1; min-width: 160px;">
            <input type="text" name="q" value="{{ q or '' }}" placeholder="Volunteer / request / category" style="width: 100%; padding: 10px; border: 1px solid var(--grey-border); border-radius: 6px;" />
          </div>
          <div style="flex: 1; min-width: 120px;">
            <input type="date" name="start" value="{{ start or '' }}" style="width: 100%; padding: 10px; border: 1px solid var(--grey-border); border-radius: 6px;" />
          </div>
          <div style="flex: 1; min-width: 120px;">
            <input type="date" name="end" value="{{ end or '' }}" style="width: 100%; padding: 10px; border: 1px solid var(--grey-border); border-radius: 6px;" />
          </div>
          <div style="flex: 0 0 auto;">
            <button type="submit" style="background: var(--accent); color: var(--white); border: none; border-radius: 6px; padding: 10px 20px;">Filter</button>
          </div>
        </form>
        {% if items and items|length > 0 %}
          <div class="table-responsive">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Request</th>
                  <th>Category</th>
                  <th>Volunteer</th>
                  <th>Contact</th>
                </tr>
              </thead>
              <tbody>
                {% for h in items %}
                <tr>
                  <td>{{ h.date_completed.date() }}</td>
                  <td>{{ h.request.title if h.request else '-' }}</td>
                  <td>{{ h.category.name if h.category else '-' }}</td>
                  <td>{{ (h.csr.first_name ~ ' ' ~ h.csr.last_name) if h.csr and (h.csr.first_name or h.csr.last_name) else (h.csr.username if h.csr else '-') }}</td>
                  <td>{{ h.csr.email if h.csr and h.csr.email else (h.csr.username if h.csr else '-') }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p>No completed matches found.</p>
        {% endif %}
      {% endif %}
    </main>
  </div>
</body>
</html>