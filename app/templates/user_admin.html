{% set uname = session.get('username','Username') %}
{% set urole = (session.get('role','USER ADMIN') | upper) %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Admin</title>
  <style>
    :root { --blue:#004aad; --light:#c2e9ff; --red:#ff2828; --yellow:#ffa51f; --green:#00bf63; --control-h:48px; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Canva Sans',Arial,Helvetica,sans-serif;background:var(--light);color:#000}

    /* Top bar */
    .topbar{display:flex;align-items:center;justify-content:space-between;background:var(--blue);color:#fff;padding:16px 24px;border-bottom:2px solid #003d8a}
    .brand{font-size:24px;font-weight:800}
    .account{display:flex;gap:16px;align-items:center}
    .who{text-align:right;line-height:1.1}
    .who .name{display:block;font-size:24px;font-weight:800}
    .who small{font-weight:700;opacity:.9}
    .logout{background:var(--red);color:#fff;text-decoration:none;font-weight:800;padding:8px 18px;border-radius:10px;border:1px solid #000}

    /* Layout */
    .shell{display:flex;min-height:calc(100vh - 64px)}
    .sidebar{width:260px;background:var(--blue);color:#fff;padding:26px 22px}
    .sidebar h3{margin:0 0 18px 0;font-size:20px;font-weight:800}
    .navlink{display:block;color:#fff;text-decoration:none;margin:14px 0;font-size:18px;font-weight:700}
    .navlink.active{color:var(--yellow)} /* highlight current page text */
    .main{flex:1;background:var(--light);padding:34px}
    .title{font-size:32px;font-weight:800;margin:4px 0 18px 0;text-align:center}

    /* Form elements */
    label{display:block;font-weight:800;font-size:20px;margin:14px 0 6px}
    select,input{width:100%;padding:14px;border:1px solid #000;border-radius:10px;background:#fff;font-size:18px}
    .row{max-width:780px;margin:0 auto}

    .btn{display:inline-block;border:1.5px solid #000;border-radius:10px;font-weight:800;padding:14px 28px;cursor:pointer;text-align:center;text-decoration:none}
    .btn-yellow{background:var(--yellow);color:#fff}
    .btn-orange{background:var(--yellow);color:#000;border:1px solid #000;border-radius:14px;font-weight:800;padding:10px 22px}
    .btn-red{background:var(--red);color:#fff}
    .btn-green{background:var(--green);color:#fff}

    /* Full-width action helper */
    .actions-col{max-width:780px;margin:18px auto 0;display:flex;flex-direction:column;gap:14px}
    .btn-block{width:100%;height:56px;font-size:18px;border-radius:10px}

    /* Filters row */
    .filters{display:flex;gap:16px;align-items:center;justify-content:flex-start;margin:10px auto 14px;max-width:880px}
    .filters .search{flex:1}

    /* Blue select pill with chevron; make all controls same height */
    .select-wrap{position:relative;display:inline-block;}
    .select-blue{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      background:#0f4fb4;color:#fff;font-weight:800;height:var(--control-h);
      padding:0 46px 0 16px;border:1px solid #000;border-radius:18px;font-size:18px;min-width:220px;
      box-shadow:inset 0 0 0 2px rgba(255,255,255,.12)
    }
    .select-wrap::after{content:"";position:absolute;right:14px;top:50%;transform:translateY(-50%) rotate(45deg);width:10px;height:10px;border-right:3px solid #fff;border-bottom:3px solid #fff;pointer-events:none}
    .filters .search input{height:var(--control-h);border:1px solid #000;border-radius:14px;padding:0 16px;font-size:18px}
    .filters .btn-orange{height:var(--control-h);display:inline-flex;align-items:center;justify-content:center;min-width:140px}

    /* Table with column lines */
    .tablewrap{max-width:880px;margin:0 auto;background:#fff;border:1px solid #000;border-radius:12px;overflow:hidden}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:16px}
    thead{background:#0a4aa9;color:#fff}
    th,td{padding:14px 16px;font-size:16px;border-bottom:1px solid #d5e6f7;border-right:1px solid #d5e6f7}
    th:last-child,td:last-child{border-right:none}
    th:first-child,td:first-child{width:64px}
    .actions{text-align:right}

    /* Edit button in table */
    .edit-btn{display:inline-block;background:#ffa51f;color:#000;text-decoration:none;padding:10px 22px;border:1px solid #000;border-radius:12px;font-weight:400;box-shadow:0 2px 0 rgba(0,0,0,.25)}
    .edit-btn:hover,.edit-btn:focus{filter:brightness(.96);text-decoration:none}

    .status-active{color:var(--green);font-weight:800}
    .status-suspended{color:var(--red);font-weight:800}

    /* === Update User page button styles (ONLY inside .update-buttons) === */
    .update-buttons .btn-block{width:100%;height:60px;font-size:20px;font-weight:800;border-radius:10px;border:1px solid #000}
    .update-buttons .btn-yellow{background:#ffa51f;color:#fff}
    .update-buttons .btn-blue{background:#0f4fb4;color:#fff}
    .update-buttons .btn-red{background:#ff2828;color:#fff}
    .update-buttons .btn-green{background:#00bf63;color:#fff}
    .update-buttons .actions-col{margin-top:18px;display:flex;flex-direction:column;gap:16px;max-width:780px;margin-left:auto;margin-right:auto}

    /* Pager */
    .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin:16px 0}
    .pagebtn{border:1.5px solid #000;border-radius:8px;background:#fff;padding:8px 12px;text-decoration:none;color:#000}
    .pagebtn.active{background:#1e66e8;color:#fff;border-color:#000}
  </style>
</head>
<body>

  <!-- TOP BAR -->
  <div class="topbar">
    <div class="brand">VOLUNTEER MANAGEMENT SYSTEM</div>
    <div class="account">
      <div class="who">
        <span class="name">{{ uname }}</span>
        <small>{{ urole }}</small>
      </div>
      <a href="{{ url_for('boundary.logout') }}" class="logout">LOGOUT</a>
    </div>
  </div>

  <div class="shell">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <h3>User Management</h3>
      <a class="navlink {% if view == 'create' %}active{% endif %}" href="{{ url_for('boundary.admin_new_user') }}">Create User</a>
      <a class="navlink {% if view == 'users' or view == 'edit' %}active{% endif %}" href="{{ url_for('boundary.admin_users', type='accounts') }}">Update User</a>
    </aside>

    <!-- MAIN -->
    <main class="main">
      {% if view == 'create' %}
        <h1 class="title">CREATE USER</h1>
        <div class="row">
          <form method="post" action="{{ url_for('boundary.admin_create_user') }}">
            <label>User</label>
            <select name="user_type">
              <option value="" disabled selected>Select user type</option>
              <option value="account">User Account</option>
              <option value="profile">User Profile</option>
            </select>

            <label>Role</label>
            <select name="role" required>
              <option value="" disabled selected>Select Role</option>
              <option value="User Admin">User Admin</option>
              <option value="CSR Representative">CSR Representative</option>
              <option value="Person in Need">Person in Need</option>
              <option value="Platform Manager">Platform Manager</option>
            </select>

            <label>Full Name</label>
            <input type="text" name="full_name" placeholder="Enter your full name"/>

            <label>Contact Number</label>
            <input type="text" name="phone" placeholder="+65"/>

            <label>Username</label>
            <input type="text" name="username" placeholder="Enter your username" required/>

            <label>Password</label>
            <input type="password" name="password" placeholder="Enter your password" required/>

            <div class="actions-col">
              <button class="btn btn-yellow btn-block" type="submit">Create Account</button>
            </div>
          </form>
        </div>

      {% elif view == 'users' %}
        <h1 class="title">VIEW/UPDATE/SUSPEND/SEARCH USER</h1>

        <!-- Filters -->
        <form class="filters" method="get" action="{{ url_for('boundary.admin_users') }}">
          <div class="select-wrap">
            <select class="select-blue" name="type" onchange="this.form.submit()">
              <option value="accounts" {{ 'selected' if type=='accounts' else '' }}>User Accounts</option>
              <option value="profiles" {{ 'selected' if type!='accounts' else '' }}>User Profiles</option>
            </select>
          </div>
          <div class="search">
            <input type="text" name="q" value="{{ q }}" placeholder="Search user account or profile"/>
          </div>
          <button class="btn-orange" type="submit">Search</button>
        </form>

        <!-- Table -->
        <div class="tablewrap">
          <table>
            <thead>
              <tr>
                <th>ID</th><th>Username</th><th>Role</th><th>Status</th><th class="actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.role }}</td>
                <td>{% if u.is_active %}<span class="status-active">Active</span>{% else %}<span class="status-suspended">Suspended</span>{% endif %}</td>
                <td class="actions"><a class="edit-btn" href="{{ url_for('boundary.admin_edit_user', user_id=u.id) }}">Edit</a></td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        {% if pages and pages > 1 %}
        <div class="pager">
          <a class="pagebtn {{ 'disabled' if page<=1 else '' }}" href="{{ url_for('boundary.admin_users', q=q, type=type, page=page-1) }}">Previous</a>
          {% for p in range(1, pages+1) %}
            <a class="pagebtn {{ 'active' if p==page else '' }}" href="{{ url_for('boundary.admin_users', q=q, type=type, page=p) }}">{{ p }}</a>
          {% endfor %}
          <a class="pagebtn {{ 'disabled' if page>=pages else '' }}" href="{{ url_for('boundary.admin_users', q=q, type=type, page=page+1) }}">Next</a>
        </div>
        {% endif %}

      {% elif view == 'edit' %}
        <h1 class="title">UPDATE USER</h1>
        <div class="row">
          <!-- Update form -->
          <form method="post" action="{{ url_for('boundary.admin_update_user', user_id=user.id) }}">
            <label>Role</label>
            <select name="role" required>
              <option value="User Admin" {{ 'selected' if user.role=='User Admin' else '' }}>User Admin</option>
              <option value="CSR Representative" {{ 'selected' if user.role=='CSR Representative' else '' }}>CSR Representative</option>
              <option value="Person in Need" {{ 'selected' if user.role=='Person in Need' else '' }}>Person in Need</option>
              <option value="Platform Manager" {{ 'selected' if user.role=='Platform Manager' else '' }}>Platform Manager</option>
            </select>

            <label>Full Name</label>
            <input type="text" name="full_name" value="{{ user.profile.full_name if user.profile else '' }}" placeholder="Enter your full name"/>

            <label>Contact Number</label>
            <input type="text" name="phone" value="{{ user.profile.phone if user.profile else '' }}" placeholder="+65"/>

            <label>Username</label>
            <input type="text" name="username" value="{{ user.username }}" placeholder="Enter your username" required/>

            <label>Password</label>
            <input type="password" name="password" placeholder="Enter your password (leave blank to keep current)"/>

            <!-- Submit button (inside form) -->
            <div class="update-buttons">
              <div class="actions-col">
                <button class="btn btn-yellow btn-block" type="submit">Submit</button>
              </div>
            </div>
          </form>

          <!-- Suspend/Activate + Back (separate from the form) -->
          <div class="update-buttons">
            <div class="actions-col" style="margin-top:14px">
              {% if user.is_active %}
                <form method="post" action="{{ url_for('boundary.admin_suspend_user', user_id=user.id) }}">
                  <button class="btn btn-red btn-block" type="submit">Suspend User</button>
                </form>
              {% else %}
                <form method="post" action="{{ url_for('boundary.admin_activate_user', user_id=user.id) }}">
                  <button class="btn btn-green btn-block" type="submit">Activate User</button>
                </form>
              {% endif %}
            </div>

            <div class="actions-col" style="margin-top:14px">
              <a class="btn btn-blue btn-block" href="{{ url_for('boundary.admin_users', type='accounts') }}">Back</a>
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Flash pop-up -->
      {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div id="flash" style="display:none">{{ messages|join(' • ') }}</div>
        <script>const f=document.getElementById('flash');if(f&&f.textContent.trim())alert(f.textContent.trim());</script>
      {% endif %}
      {% endwith %}
    </main>
  </div>
</body>
</html>
