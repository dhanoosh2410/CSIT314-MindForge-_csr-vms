name: CI — Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    # Ensure Python can import the package modules in the repository root during CI
    env:
      PYTHONPATH: ${{ github.workspace }}
    strategy:
      matrix:
        python-version: [3.11, 3.12]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # Install dev/test dependencies if provided; otherwise install pytest when tests exist
          if [ -f requirements-dev.txt ]; then
            echo "Found requirements-dev.txt — installing dev/test dependencies"
            pip install -r requirements-dev.txt
          else
            if [ -d "tests" ]; then
              echo "tests/ found but no requirements-dev.txt — installing pytest"
              pip install pytest
            fi
          fi

      - name: Check Python syntax (compile all .py files)
        run: |
          python -m compileall -q .

      - name: Run tests if present
        run: |
          if [ -d "tests" ]; then
            echo "Found tests/ — running pytest"
            pytest -q
          else
            echo "No tests directory found, skipping pytest"
          fi

      - name: Lint with flake8 (optional)
        run: |
          if python -c "import pkgutil; import sys; sys.exit(0 if pkgutil.find_loader('flake8') else 1)"; then
            echo "flake8 is installed — running lint"
            flake8 || (echo "flake8 failed" && exit 1)
          else
            echo "flake8 not installed, skipping lint"
          fi
